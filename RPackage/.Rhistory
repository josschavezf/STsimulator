sig1=which(rownames(expr) %in% pattern$GeneID)
sig0=which(!(rownames(expr) %in% pattern$GeneID))
power=mean(tt[sig1]<0.05, na.rm=T)
type1=mean(tt[sig0]<0.05, na.rm=T)
# load data
expr=fread(paste0("UseDocker/OutputData/", FileName, "_count_", 1, ".tsv")) %>% as.data.frame %>%
column_to_rownames("GeneName")
pattern=fread(paste0("UseDocker/OutputData/", FileName, "_expr_pattern_",1,".tsv"))
meta=data.frame(fread(paste0("UseDocker/OutputData/", FileName, "_meta_1.tsv")))
para=ParaDigest(paste("UseDocker/ParameterFile/", FileName, ".tsv"))
# load data
expr=fread(paste0("UseDocker/OutputData/", FileName, "_count_", 1, ".tsv")) %>% as.data.frame %>%
column_to_rownames("GeneName")
pattern=fread(paste0("UseDocker/OutputData/", FileName, "_expr_pattern_",1,".tsv"))
meta=data.frame(fread(paste0("UseDocker/OutputData/", FileName, "_meta_1.tsv")))
para=ParaDigest(paste0("UseDocker/ParameterFile/", FileName, ".tsv"))
# cell-cell distance
CellType1=pattern$CellType[1]
CellType2=pattern$AdjCellType[1]
dist=crossdist(meta[which(meta$annotation==CellType1), 3], meta[which(meta$annotation==CellType1),4],
meta[which(meta$annotation==CellType2),3], meta[which(meta$annotation==CellType2),4])
rownames(dist)=meta[which(meta$annotation==CellType1),"Cell"]
colnames(dist)=meta[which(meta$annotation==CellType2),"Cell"]
# cutoff
dmax=max(max(meta$x.loc)-min(meta$x.loc), max(meta$y.loc)-min(meta$y.loc))
cutoff=para$spatial_int_dist_1_dist_cutoff*dmax
# data
dlong=dist %>% as.data.frame() %>% rownames_to_column("CellType1")  %>%
pivot_longer(-CellType1, names_to="CellType2", values_to="Dist") %>%
mutate(Group=ifelse(Dist<cutoff, 1, 0)) %>%
dplyr::select(CellType1, Group) %>%
group_by(CellType1) %>%
summarise(max=max(Group))
idx1=dlong$CellType1[which(dlong$max==1)]
idx0=dlong$CellType1[which(dlong$max==0)]
# t-test
tt=unlist(mclapply(1:nrow(expr), function(f) wilcox.test(as.numeric(expr[f, idx1]),
as.numeric(expr[f, idx0]))$p.value))
sig1=which(rownames(expr) %in% pattern$GeneID)
sig0=which(!(rownames(expr) %in% pattern$GeneID))
power=mean(tt[sig1]<0.05, na.rm=T)
type1=mean(tt[sig0]<0.05, na.rm=T)
data.frame(type1, power)
fig2d1=parameter_ICG(FileName="fig2d1")
FileName="fig2d1"
parameter_ICG=function(FileName) {
# load data
expr=fread(paste0("UseDocker/OutputData/", FileName, "_count_", 1, ".tsv")) %>% as.data.frame %>%
column_to_rownames("GeneName")
pattern=fread(paste0("UseDocker/OutputData/", FileName, "_expr_pattern_",1,".tsv"))
meta=data.frame(fread(paste0("UseDocker/OutputData/", FileName, "_meta_1.tsv")))
para=ParaDigest(paste0("UseDocker/ParameterFile/", FileName, ".tsv"))
# cell-cell distance
CellType1=pattern$CellType[1]
CellType2=pattern$AdjCellType[1]
dist=crossdist(meta[which(meta$annotation==CellType1), 3], meta[which(meta$annotation==CellType1),4],
meta[which(meta$annotation==CellType2),3], meta[which(meta$annotation==CellType2),4])
rownames(dist)=meta[which(meta$annotation==CellType1),"Cell"]
colnames(dist)=meta[which(meta$annotation==CellType2),"Cell"]
# cutoff
dmax=max(max(meta$x.loc)-min(meta$x.loc), max(meta$y.loc)-min(meta$y.loc))
cutoff=para$spatial_int_dist_1_dist_cutoff*dmax
# data
dlong=dist %>% as.data.frame() %>% rownames_to_column("CellType1")  %>%
pivot_longer(-CellType1, names_to="CellType2", values_to="Dist") %>%
mutate(Group=ifelse(Dist<cutoff, 1, 0)) %>%
dplyr::select(CellType1, Group) %>%
group_by(CellType1) %>%
summarise(max=max(Group))
idx1=dlong$CellType1[which(dlong$max==1)]
idx0=dlong$CellType1[which(dlong$max==0)]
# t-test
tt=unlist(mclapply(1:nrow(expr), function(f) wilcox.test(as.numeric(expr[f, idx1]),
as.numeric(expr[f, idx0]))$p.value))
sig1=which(rownames(expr) %in% pattern$GeneID)
sig0=which(!(rownames(expr) %in% pattern$GeneID))
power=mean(tt[sig1]<0.05, na.rm=T)
type1=mean(tt[sig0]<0.05, na.rm=T)
return(data.frame(type1, power))
}
fig2d1=parameter_ICG(FileName="fig2d1")
fig2d2=parameter_ICG(FileName="fig2d2")
fig2d3=parameter_ICG(FileName="fig2d3")
fig2d4=parameter_ICG(FileName="fig2d4")
fig2d5=parameter_ICG(FileName="fig2d5")
input="UseDocker/ParameterFile/fig2d2.tsv"
ModelFitFile="UseDocker/OutputData/SeqFISHPlus_FitExpr.Rdata"
ParaSimulation(input=input, ModelFitFile=ModelFitFile)
detach(para)
detach(para)
detach(para)
input="UseDocker/ParameterFile/fig2d2.tsv"
ModelFitFile="UseDocker/OutputData/SeqFISHPlus_FitExpr.Rdata"
ParaSimulation(input=input, ModelFitFile=ModelFitFile)
setwd("/Users/songxiaoyu152/Dropbox/SpatialTranscriptomics/Paper_Simulator")
source("Github/RPackage/R/PointSimulator_NoData.R")
source("Github/RPackage/R/PointSimulator_STData.R")
source("Github/RPackage/R/ExprSimulator.R")
source("Github/RPackage/R/scDesign2_fit_revised.R")
source("Github/RPackage/R/scDesign2_simulate_revised.R")
source("Github/RPackage/R/ParameterDigest.R")
source("Github/RPackage/R/MultiCell.R")
input="UseDocker/ParameterFile/fig2d2.tsv"
ModelFitFile="UseDocker/OutputData/SeqFISHPlus_FitExpr.Rdata"
ParaSimulation(input=input, ModelFitFile=ModelFitFile)
detach(para)
detach(para)
detach(para)
detach(para)
input="UseDocker/ParameterFile/fig2d2.tsv"
ModelFitFile="UseDocker/OutputData/SeqFISHPlus_FitExpr.Rdata"
ParaSimulation(input=input, ModelFitFile=ModelFitFile)
fig2d2=parameter_ICG(FileName="fig2d2")
fig2d2
input="UseDocker/ParameterFile/fig2d3.tsv"
ModelFitFile="UseDocker/OutputData/SeqFISHPlus_FitExpr.Rdata"
ParaSimulation(input=input, ModelFitFile=ModelFitFile)
input="UseDocker/ParameterFile/fig2d4.tsv"
ModelFitFile="UseDocker/OutputData/SeqFISHPlus_FitExpr.Rdata"
ParaSimulation(input=input, ModelFitFile=ModelFitFile)
input="UseDocker/ParameterFile/fig2d5.tsv"
ModelFitFile="UseDocker/OutputData/SeqFISHPlus_FitExpr.Rdata"
ParaSimulation(input=input, ModelFitFile=ModelFitFile)
fig2d1
fig2d3=parameter_ICG(FileName="fig2d3")
fig2d4=parameter_ICG(FileName="fig2d4")
fig2d5=parameter_ICG(FileName="fig2d5")
a=rbind(c(0.5, fig2d1),
c(0.25, fig2d2),
c(0, fig2d3),
c(-0.25, fig2d4),
c(-0.5, fig2d5)) %>%
as.data.frame() %>%
type.convert(as.is =TRUE)
save(a, file="Results/fig2d.Rdata")
a
fig2d3
save(a, file="Results/fig2d.Rdata")
getwd()
class(a)
b=a %>% pivot_longer(!V1)
p1=ggplot(b, aes(x=V1, y=value, col=name)) +
geom_point()+ geom_line()+
theme_classic() +
ylim(0,1)+
labs(x="Effect Size", y = " ")+
scale_color_discrete(name = " ", labels = c("Power", "Type I Error"))
p1
p1
b
power
class(power)
class(type1)
class(a)
class(a[1,1])
a
a[1,2]
class(fig2d1)
a=rbind(c(0.5, as.numeric(fig2d1)),
c(0.25, as.numeric(fig2d2)),
c(0, as.numeric(fig2d3)),
c(-0.25, as.numeric(fig2d4)),
c(-0.5, as.numeric(fig2d5))) %>%
as.data.frame() %>%
type.convert(as.is =TRUE)
a
save(a, file="Results/fig2d.Rdata")
b=a %>% pivot_longer(!V1)
p1=ggplot(b, aes(x=V1, y=value, col=name)) +
geom_point()+ geom_line()+
theme_classic() +
ylim(0,1)+
labs(x="Effect Size", y = " ")+
scale_color_discrete(name = " ", labels = c("Power", "Type I Error"))
p1
ggsave("Figure/fig2d.pdf", width=4, height=3)
p1=ggplot(b, aes(x=V1, y=value, col=name)) +
geom_point()+ geom_line()+
theme_classic() +
ylim(0,1)+
labs(x="Effect Size", y = " ")+
scale_color_discrete(name = " ", labels = c("Type I Error", "Power"))
ggsave("Figure/fig2d.pdf", width=4, height=3)
a
a=rbind(c(0.5, as.numeric(fig2d1)),
c(0.25, as.numeric(fig2d2)),
c(0, as.numeric(fig2d3)),
c(-0.25, as.numeric(fig2d4)),
c(-0.5, as.numeric(fig2d5))) %>%
as.data.frame() %>%
type.convert(as.is =TRUE) %>%
colnames(c("V1", "Type I Error", "Power"))
a=rbind(c(0.5, as.numeric(fig2d1)),
c(0.25, as.numeric(fig2d2)),
c(0, as.numeric(fig2d3)),
c(-0.25, as.numeric(fig2d4)),
c(-0.5, as.numeric(fig2d5))) %>%
as.data.frame() %>%
type.convert(as.is =TRUE) %>%
colnames(c("V1", "Type1", "Power"))
a=rbind(c(0.5, as.numeric(fig2d1)),
c(0.25, as.numeric(fig2d2)),
c(0, as.numeric(fig2d3)),
c(-0.25, as.numeric(fig2d4)),
c(-0.5, as.numeric(fig2d5))) %>%
as.data.frame() %>%
type.convert(as.is =TRUE) %>%
rename(c("V2"=Type1", V3="Power"))
a=rbind(c(0.5, as.numeric(fig2d1)),
c(0.25, as.numeric(fig2d2)),
c(0, as.numeric(fig2d3)),
c(-0.25, as.numeric(fig2d4)),
c(-0.5, as.numeric(fig2d5))) %>%
as.data.frame() %>%
type.convert(as.is =TRUE) %>%
rename(c(V2=Type1, V3=Power))
a=rbind(c(0.5, as.numeric(fig2d1)),
c(0.25, as.numeric(fig2d2)),
c(0, as.numeric(fig2d3)),
c(-0.25, as.numeric(fig2d4)),
c(-0.5, as.numeric(fig2d5))) %>%
as.data.frame() %>%
type.convert(as.is =TRUE) %>%
rename(c(V2="Type1", V3="Power"))
a
b=a %>% pivot_longer(!V1)
p1=ggplot(b, aes(x=V1, y=value, col=name)) +
geom_point()+ geom_line()+
theme_classic() +
ylim(0,1)+
labs(x="Effect Size", y = " ")+
scale_color_discrete(name = " ", labels = c("Type I Error", "Power"))
p1
debugSource("~/Dropbox/SpatialTranscriptomics/Paper_Simulator/codes/AnalysisCodes/Fig2D_Study_ICG.R", echo=TRUE)
p1=ggplot(b, aes(x=V1, y=value, col=name)) +
geom_point()+ geom_line()+
theme_classic() +
ylim(0,1)+
labs(x="Effect Size", y = " ")+
scale_color_discrete(name = " ", labels = c("Power", "Type I Error"))
ggsave("Figure/fig2d.pdf", width=4, height=3)
p1+p2+p3
p1=Heatmap(abs(truth-3),
col=col_fun,
cluster_rows = FALSE,
cluster_columns = FALSE,
show_heatmap_legend=F,
column_title = "True Spatial Regions")
p1
p2=Heatmap(fig2b6$heatmap,
col=col_fun,
cluster_rows = FALSE,
cluster_columns = FALSE,
show_heatmap_legend=F,
column_title = paste0("Large Effect (ARI=",
round(ARI(meta$region,fig2b6$BayesSpace), 2), ")")
)
p1
fig2b6
p2=Heatmap(fig2b6$heatmap,
col=col_fun,
cluster_rows = FALSE,
cluster_columns = FALSE,
show_heatmap_legend=F,
column_title = paste0("Large Effect (ARI=",
round(ARI(meta$region,fig2b6$BayesSpace), 2), ")")
)
fig2b6$BayesSpace
p3=Heatmap(fig2b5$heatmap,
col=col_fun,
cluster_rows = FALSE,
cluster_columns = FALSE,
show_heatmap_legend=F,
column_title = paste0("Small Effect (ARI=",
round(ARI(meta$region,fig2b5$BayesSpace), 2), ")")
)
dev.off()
dev.off()
p2=Heatmap(fig2b6$heatmap,
col=col_fun,
cluster_rows = FALSE,
cluster_columns = FALSE,
show_heatmap_legend=F,
column_title = paste0("Large Effect (ARI=",
round(ARI(meta$region,fig2b6$BayesSpace), 2), ")")
)
meta$region
FileName
FileName="fig2b1"
library(aricode)
meta=fread(paste0("UseDocker/OutputData/", FileName, "_meta_1.tsv"))
ARI(meta$region,fig2b1$BayesSpace)
FileName
ARI(meta$region,fig2b6$BayesSpace), 2)
ARI(meta$region,fig2b6$BayesSpace)
p2=Heatmap(fig2b6$heatmap,
col=col_fun,
cluster_rows = FALSE,
cluster_columns = FALSE,
show_heatmap_legend=F,
column_title = paste0("Large Effect (ARI=",
round(ARI(meta$region,fig2b6$BayesSpace), 2), ")")
)
p2
p3=Heatmap(fig2b5$heatmap,
col=col_fun,
cluster_rows = FALSE,
cluster_columns = FALSE,
show_heatmap_legend=F,
column_title = paste0("Small Effect (ARI=",
round(ARI(meta$region,fig2b5$BayesSpace), 2), ")")
)
library(patchwork)
p1+p2+p3
p.all=p1+p2+p3
ggsave(p.all, file="Figure/fig2b.pdf", hight=4, width = 12)
p.all=p1+p2+p3
pdf(file="Figure/fig2b.pdf", hight=4, width = 12)
p.all=p1+p2+p3
pdf(file="Figure/fig2b.pdf", height=4, width = 12)
p.all
dev.off()
pdf(file="Figure/fig2b.pdf", height=3, width = 9)
p.all
dev.off()
library(STsimulator)
?STsimulator
library(STsimulator)
input="UseDocker/ParameterFile/fig2d5.tsv"
ModelFitFile="UseDocker/OutputData/SeqFISHPlus_FitExpr.Rdata"
# parallel
ncores=detectCores()-2; registerDoParallel(ncores)
library(tidyverse)
library(data.table)
library(raster)
library(spatstat)
library(rlist)
library(parallel)
# parallel
ncores=detectCores()-2; registerDoParallel(ncores)
library(doParallel)
# parallel
ncores=detectCores()-2; registerDoParallel(ncores)
print(paste("No. of Cores in Use:", ncores))
print("Start the simulation")
# Digest parameters
para=ParaDigest(input)
attach(para)
setwd("/Users/songxiaoyu152/Dropbox/SpatialTranscriptomics/Paper_Simulator")
# parallel
ncores=detectCores()-2; registerDoParallel(ncores)
print(paste("No. of Cores in Use:", ncores))
print("Start the simulation")
# Digest parameters
para=ParaDigest(input)
attach(para)
# Load  data
expr=ExprLoad(para)
source("Github/RPackage/R/PointSimulator_NoData.R")
source("Github/RPackage/R/PointSimulator_STData.R")
source("Github/RPackage/R/ExprSimulator.R")
source("Github/RPackage/R/scDesign2_fit_revised.R")
source("Github/RPackage/R/scDesign2_simulate_revised.R")
source("Github/RPackage/R/ParameterDigest.R")
source("Github/RPackage/R/MultiCell.R")
# parallel
ncores=detectCores()-2; registerDoParallel(ncores)
print(paste("No. of Cores in Use:", ncores))
print("Start the simulation")
# Digest parameters
para=ParaDigest(input)
attach(para)
# Load  data
expr=ExprLoad(para)
feature=CellFeatureLoad(para)
colnames(expr)=feature[,1]
print("Finished loading data")
# Simulate cells
if (path==1) {
cell_loc_list=ParaCellsNoST(para=para, all_seeds=all_seeds)
}
if (path==2) {
cell_loc_list=ParaCellsST(para=para, feature=feature, all_seeds=all_seeds)
}
if (path==3) {
cell_loc_list=ParaExistingCellsST(m=num_simulated_datasets, feature=feature)
}
print("Finished simulating the cell spatial maps")
# Trim  data (no. of cells) in expr to make the expr estimation faster
ctype=table(feature[,1])
idxc=foreach (i = 1:length(ctype), .combine = "c") %dopar% {
if (ctype[i]>2500) {
sample(which(feature[,1]==names(ctype)[i]), 2500)
} else {which(feature[,1]==names(ctype)[i])
}
}
expr2=expr[,idxc]
# Copula
CopulaEst=ParameterCopula(para=para, expr=expr2, feature=feature, ncores=ncores)
# ModelFitFile=ParaFitExpr(para=para, expr=expr2, feature=feature,
#                          CopulaEst=CopulaEst, ncores=ncores, save=T)
# Simulate Expr for these cells
#
if( is.null(ModelFitFile)==F) {
load(ModelFitFile)
} else {model_params=NULL}
sim_method=ifelse(gene_cor=="TRUE", "copula", "ind")
# fit by input data
if (is.null(model_params)) {
model_params=ParaFitExpr(para, expr, feature, CopulaEst, ncores=ncores, save=F)
}
# simulate
i=1
seed=all_seeds[[i]]
ppp.obj=cell_loc_list[[i]]
depth_simu_ref_ratio=expr_depth_ratio
region_specific_model
region_specific_model=region_specific_model
expr=as.matrix(expr)
R=length(ppp.obj)
cell_type_sel=names(table(colnames(expr)))
Genes=rownames(expr)
region_specific_model!="TRUE"
ppp.obj
r=1
sim.count= foreach (r = 1:R) %dopar%{
Use_scDesign2_1region(ppp.obj1=ppp.obj[[r]],
Genes=Genes,
model_params=model_params,
depth_simu_ref_ratio=depth_simu_ref_ratio,
cell_type_sel=cell_type_sel,
seed=seed*31+r*931,
sim_method = sim_method)
}
sim.count1=sim.count
sim.count= foreach (r = 1:R) %dopar%{
Use_scDesign2_1region(ppp.obj1=ppp.obj[[r]],
Genes=Genes,
model_params=model_params,
depth_simu_ref_ratio=depth_simu_ref_ratio,
cell_type_sel=cell_type_sel,
seed=seed*31+r*931,
sim_method = sim_method)
}
sim.count[1:3,1:3]
length(sim.count)
sim.count[[1]][1:3, 1:3]
sim.count1[[1]][1:3, 1:3]
ppp.obj1=ppp.obj[[r]]
set.seed(seed)
seed
n.ordered=table(ppp.obj1$marks)
exist.cell.type=names(n.ordered)
cell_type_prop=n.ordered/ppp.obj1$n
model_params_exist=model_params[exist.cell.type]
sim_count <- scDesign2.revised(model_params=model_params_exist,
n_cell_new=ppp.obj1$n,
cell_type_prop = cell_type_prop,
depth_simu_ref_ratio=depth_simu_ref_ratio,
sim_method =sim_method)
sim_count1=sim_count
set.seed(seed)
sim_count <- scDesign2.revised(model_params=model_params_exist,
n_cell_new=ppp.obj1$n,
cell_type_prop = cell_type_prop,
depth_simu_ref_ratio=depth_simu_ref_ratio,
sim_method =sim_method)
sim_count[1:4,1:4]
sim_count1[1:4,1:4]
sim_count1==sim_count
library(STsimulator)
source("Github/RPackage/R/PointSimulator_NoData.R")
source("Github/RPackage/R/PointSimulator_STData.R")
source("Github/RPackage/R/ExprSimulator.R")
source("Github/RPackage/R/scDesign2_fit_revised.R")
source("Github/RPackage/R/scDesign2_simulate_revised.R")
source("Github/RPackage/R/ParameterDigest.R")
source("Github/RPackage/R/MultiCell.R")
sim_count=Use_scDesign2(ppp.obj=cell_loc_list[[i]],
model_params=model_params,
expr=expr,
feature=feature,
depth_simu_ref_ratio=expr_depth_ratio,
sim_method=sim_method,
region_specific_model=region_specific_model,
seed=all_seeds[[i]])
sim_count=Use_scDesign2(ppp.obj=cell_loc_list[[i]],
model_params=model_params,
expr=expr,
feature=feature,
depth_simu_ref_ratio=expr_depth_ratio,
sim_method=sim_method,
region_specific_model=region_specific_model,
seed=all_seeds[[i]])
sim_count1=sim_count
sim_count=Use_scDesign2(ppp.obj=cell_loc_list[[i]],
model_params=model_params,
expr=expr,
feature=feature,
depth_simu_ref_ratio=expr_depth_ratio,
sim_method=sim_method,
region_specific_model=region_specific_model,
seed=all_seeds[[i]])
sim_count[[1]][1:5,1:4]
sim_count1[[1]][1:5,1:4]
library(STsimulator)
pkgload::dev_help('cell.loc.fc')
pkgload::dev_help('cell.loc.1region.fc')
library(STsimulator)
library(STsimulator)
detach("package:STsimulator", unload = TRUE)
library(STsimulator)
